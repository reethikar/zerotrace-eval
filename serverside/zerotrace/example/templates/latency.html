<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <meta charset = "utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Calculate Latency Using WebSockets</title>
  </head>
  <body>
    <header>
        <ul class="nav justify-content-center">
            <li class="nav-item">
                <img class="header-img" src="/static/images/cse-logo.png">
            </li>
            <li class="nav-item">
                <img id="brave-logo" src="/static/images/brave-logotype-full-color.png" height="70px">
            </li>
        </ul>
    </header>
    <div class="main-section">
        <div id="explanation-section">
            <p>
                The experiment should take no longer than a couple minutes.
            </p>
            <h4>Measurement status: <span id="status">Running</span></h4>
            <!-- <div class="loader" id="loader"></div> -->
            <div class="progress" id="progress">
              <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <!-- <div>{{.TotalPings}}</div> -->
        </div>
    </div>

    <script>
      function getLatencyWebSocket() {
        let progress = 0;
        let totalPings = parseInt("{{.TotalPings}}");
        return new Promise(function(resolve, reject) {
          var socket = new WebSocket("{{.WebSocketEndpoint}}");
          socket.onerror = function (err) {
            console.log("Encountered WebSocket error: " + err.message);
            reject(err.toString());
          }
          socket.onopen = function() {
            console.log("WebSocket connection established.");
          }
          socket.onclose = function(event) {
            console.log("WebSocket connection closed.");
            resolve();
          }
          socket.onmessage = function(event) {
            socket.send(event.data);
            console.log("Echoed data: " + event.data);
            progress = progress + 1;
            let progVal = 100 * progress / totalPings;
            document.getElementById("progress-bar").style = `width: ${progVal}%`;
          }
        });
      }
      getLatencyWebSocket().then(() => {
        document.getElementById("status").innerHTML = "Done";
        document.getElementById("progress").style.display = "none";
      })
      .catch((err) => {
        document.getElementById("status").innerHTML = "Done";
        document.getElementById("progress").style.display = "none";
        console.log(err);
      });
    </script>
  </body>
</html>
